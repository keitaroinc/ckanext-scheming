{% extends 'package/new_package_form.html' %}

{% block errors %}
  {%- if errors -%}
    {%- set schema = h.scheming_get_dataset_schema(dataset_type) -%}
    {%- snippet 'scheming/snippets/errors.html',
      errors=errors, fields=schema.dataset_fields,
      entity_type='dataset', object_type=dataset_type -%}
  {%- endif -%}
{% endblock %}

{% block basic_fields %}
  {%- if not dataset_type -%}
    <p>
    dataset_type not passed to template. your version of CKAN
    might not be compatible with ckanext-scheming
    </p>
  {%- endif -%}
  {%- set schema = h.scheming_get_dataset_schema(dataset_type) -%}
  {%- for field in schema.dataset_fields -%}
    {%- if field.form_snippet is not none -%}
      {%- snippet 'scheming/snippets/form_field.html',
        field=field, data=data, errors=errors, licenses=c.licenses,
        entity_type='dataset', object_type=dataset_type -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if 'resource_fields' not in schema -%}
    <!-- force controller to skip resource-editing step for this type -->
    <input type="hidden" name="_ckan_phase" value="" />
  {%- endif -%}
{% endblock %}

{% block metadata_fields %}
  {% block package_metadata_fields_custom %}
    {% block custom_fields %}
    {% if h.scheming_show_custom_extras() %}
    {% set extras = h.scheming_exclude_extras_from_form(data.extras, h.scheming_get_dataset_schema(dataset_type)) %}
      {% snippet 'snippets/custom_form_fields.html', extras=extras, errors=errors, limit=3 %}
    {% endif %}
    {% endblock %}

    {% if c.action == 'edit' %}
    {% block dataset_relationships %}
        <div class="control-group control-full">
            {% if c.action == 'edit' %}
                {% set selected_datasets = h.get_dataset_relations(c.pkg_dict['id']) %}
            {% endif %}
            <label class="control-label" for="field-related-datasets">Related Datasets</label>
            <div class="controls">
                <select class="js-example-placeholder-multiple field-related-datasets" id='field-related-datasets' name="related-datasets" multiple="multiple" style="width: 75%">
                    {% for item in h.get_user_available_datasets(c.user) %}
                        {% if c.action == 'edit' and item['value'] != c.pkg_dict['id'] %}
                        <option value="{{item['value']}}" {% if item['value'] in selected_datasets %} selected="selected" {% endif %}>
                            {{item['name']}}
                        </option>
                        {% elif item['value'] != c.pkg_dict['id']%}
                        <option value="{{item['value']}}">
                            {{item['name']}}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
    {% endblock %}
    {% endif %}

  {% endblock %}

{% endblock %}
